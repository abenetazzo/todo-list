@page "/todos"
@using Todo.Domain.Todos
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudText Typo="Typo.h4" GutterBottom="true">Todo List - MudBlazor</MudText>

    <!-- Nuovo Todo -->
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6">Aggiungi un nuovo Todo</MudText>
        <MudTextField Label="Descrizione Todo" @bind-Value="newTodo.Title" FullWidth="true" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateTodo" Class="mt-2">
            Aggiungi
        </MudButton>
    </MudPaper>

    <!-- Griglia di Todo -->
    @if (todos == null)
    {
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Caricamento...</MudText>
    }
    else if (!todos.Any())
    {
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Nessun todo trovato.</MudText>
    }
    else
    {
        <MudGrid>
            @foreach (var todo in todos)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">@todo.Title</MudText>
                            <MudChip T="string" Color="@GetChipColor(todo.IsCompleted)" Class="mt-2">
                                @(todo.IsCompleted ? "Completato" : "Incompleto")
                            </MudChip>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => EditTodo(todo)">
                                <MudIcon Icon="@Icons.Material.Filled.Edit" /> Modifica
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => DeleteTodo(todo.Id)">
                                <MudIcon Icon="@Icons.Material.Filled.Delete" /> Elimina
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    <MudDialog @bind-Visible="isEditing" MaxWidth="MaxWidth.Small">
        <DialogContent>
            <MudText Typo="Typo.h6">Modifica Todo</MudText>
            <MudTextField Label="Titolo" @bind-Value="editingTodo!.Title" FullWidth="true" />
            <MudCheckBox T="bool" Label="Completato" @bind-Value="editingTodo.IsCompleted" />
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="UpdateTodo" Color="Color.Primary">Salva</MudButton>
            <MudButton OnClick="CancelEdit" Color="Color.Secondary">Annulla</MudButton>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    private TodoItem[]? todos;
    private CreateTodoItemDTO newTodo = new();
    private TodoItem? editingTodo;
    private bool isEditing = false;
    private readonly DialogOptions _dialogOptions = new() { FullWidth = true };
    
    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    private async Task LoadTodos()
    {
        todos = await Http.GetFromJsonAsync<TodoItem[]>("todos") ?? [];
    }

    private async Task CreateTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodo.Title))
            return; // Do not create todo with empty title

        var response = await Http.PostAsJsonAsync("todos", newTodo);
        if (response.IsSuccessStatusCode)
        {
            newTodo = new();
            await LoadTodos();  // Refresh list
        }
        else
        {
            // Handle error (e.g., show a message to the user)
        }
    }

    private void EditTodo(TodoItem todo)
    {
        editingTodo = todo;
        isEditing = true;
    }

    private void CancelEdit()
    {
        editingTodo = null;
        isEditing = false;
        StateHasChanged();
    }

    private async Task UpdateTodo()
    {
        if (editingTodo == null || string.IsNullOrEmpty(editingTodo.Title)) return;

        var response = await Http.PutAsJsonAsync($"todos/{editingTodo.Id}", editingTodo);
        if (response.IsSuccessStatusCode)
        {
            await LoadTodos();
            editingTodo = null;
            isEditing = false;
        }
    }

    private async Task DeleteTodo(int id)
    {
        var response = await Http.DeleteAsync($"todos/{id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadTodos();
        }
    }

    private Color GetChipColor(bool isCompleted) => isCompleted ? Color.Success : Color.Warning;

    private async Task LogToConsole(string message)
    {
        await JSRuntime.InvokeVoidAsync("console.log", message);
    }
}